<!DOCTYPE html>
<html>
<head>
    <title>
        
    </title>
    <style>
        body {
            font-family: "Helvetica";
        }
        #code {
            white-space: pre;  
            font-family: "Lucida Console", Monaco, monospace;
            font-size: 10pt;
            height: 400px;
            overflow-y: scroll;
        }
        #code li {
            margin: -7px 0;
        }
        .kwd {
            color: #2d2ee7;
        }
        .op {
            color: #c46113;
        }
        .dec, .str, .val {
            color: purple;
        }
        .com {
            color: green;
        }
        #output {
            height: 150px;
            overflow-y: scroll;
            margin: 6px 0px;
            border: solid black 1px;
            font-size: 80%;
        }
        #input {
            border:solid black 1px;
            width: 70%;
            margin-bottom: 8px;
        }
        #output div {
            background-color: #c6bfcc;
            margin: 3px 0px;
            padding: 2px 10px;
        }
        #code ol {
            counter-reset: item;
            list-style: none;
            margin-top: -20px;
        }
        #code li {
            counter-increment: item;
        }
        #code li:before {
            margin-right: 30px;
            content: counter(item);
            background: #1c7998;
            color: white;
            width: 4.2em;
            text-align: right;
            padding-right: 4px;
            display: inline-block;
        }
        #code li.validBreakpoint:before {
            background: #24acd9;
        }
        #code li.breakpoint:before {
            background: #c31010;
        }
        #status, #lastbreakpoint {
            color: green;
        }
    </style>
</head>
<body>
    <h1>{{.FileName}}</h1>
    <button id="runButton">run</button>
    <button id="continueButton">continue</button>
    <button id="stopButton">stop</button>
    <div id="output"></div>
    <label>Input: </label><input type="text" id="input"/>
    <h2>Status: <span id="status">not started</span> Last breakpoint: <span id="lastbreakpoint">0</span></h2>
    <div id="code">
        {{.Code}}
    </div>
    <script>
    var breakpoints = {};

    document.getElementById('runButton').onclick = function (evt) {
        document.getElementById('output').innerHTML = '';
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/run');
        xhr.send();
    }
    document.getElementById('continueButton').onclick = function (evt) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/continue');
        xhr.send();
    }
    document.getElementById('stopButton').onclick = function (evt) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/stop');
        xhr.send();
    }
    document.getElementById('code').addEventListener('click', function (evt) {
        var ele = evt.target;
        while (ele.nodeName !== "LI") { 
            ele = ele.parentElement;
            if (!ele || ele.id == 'code') {
                return;
            }
        }
        var linenum = ele.getAttribute('linenum');
        if (linenum) {
            var xhr = new XMLHttpRequest();
            if (breakpoints[linenum]) {
                delete breakpoints[linenum];
                xhr.open('GET', '/clearBreakpoint/' + linenum);
                ele.classList.remove('breakpoint');         
            } else {
                xhr.open('GET', '/setBreakpoint/' + linenum);
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        breakpoints[linenum] = true;
                        ele.classList.add('breakpoint');
                    }
                };
            } 
            xhr.send();
        }
    }, false);

    var inputBox = document.getElementById('input');
    inputBox.addEventListener("keydown", function(event) {
        if (event.keyCode == 13) {
            event.preventDefault();
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/writeInput');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    if (xhr.responseText !== "not ready") {
                        inputBox.value = '';
                    }
                }
            };
            xhr.send(JSON.stringify(inputBox.value));

        }
    });

    {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', '/getValidBreakpoints');
        xhr.onload = function() {
            if (xhr.status === 200) {
                var validBreakpoints = JSON.parse(xhr.responseText);
                var lis = document.querySelectorAll('#code li');
                for (var i in lis) {
                    var linenum = lis[i].getAttribute('linenum');
                    if (validBreakpoints[linenum]) {
                        lis[i].classList.add('validBreakpoint');
                    }
                }
            }
        };
        xhr.send();
    }
    
    {
        let output = document.getElementById('output');
        window.setInterval(function () {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/readOutput');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var lines = JSON.parse(xhr.responseText);
                    for (var i in lines) {
                        var div = document.createElement('div');
                        div.innerText = lines[i];
                        output.appendChild(div);
                        output.scrollTop = output.scrollHeight;
                    }
                }
            };
            xhr.send();
        }, 200)
    }

    {
        let status = document.getElementById('status');
        let lastbreakpoint = document.getElementById('lastbreakpoint');
        window.setInterval(function () {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/status');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var [state, line] = xhr.responseText.split(' ');
                    status.innerText = state;
                    lastbreakpoint.innerText = line;
                }
            };
            xhr.send();
        }, 200)
    }


    </script>
</body>
</html>